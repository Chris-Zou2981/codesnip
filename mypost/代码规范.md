# 技术开发规范

---

# 目录

- 代码管理规范
- 环境使用规范
- 代码编写规范
- 代码检查规范
- 数据库规范
- 数据接口规范
- 上线规范

---

# 代码管理规范

- 使用 git 进行代码管理
- 每天提交当日编写的代码到远程仓库
- 长期分支如下
	- dev: 开发人员可直接提交代码，用于开发环境测试
	- testing：指定专人进行合并更新，专门用于上线前测试
	- master: 不能直接提交代码，需要在工蜂提交 merge request 且 review 后才能合并
- 确保提交历史容易查看
- 一次 commit 的代码尽量少，不要涉及太多的功能
- 格式改动和逻辑改动不要放在同一提交
- 合并代码不需要加 commit message

---
# 环境使用规范

- 开发环境打开错误显示和错误报告，及早发现问题
	- ini_set('display_errors', 1);
	- ini_set('display_startup_errors', 1);
	- error_reporting(E_ALL);
- 正式环境关闭错误显示和错误报告，只记录日志
	- ini_set('display_errors', 0);
	- error_reporting(E_ALL ^ E_NOTICE); 
	- php.ini
		- log_errors = On 
		- error_log = /var/log/php-error.log 

---
# 代码编写规范

- 缩进统一用 4 个空格
- class, if, for 后的大括号统一不起新行
- 所有逗号后加空格，操作符两边加空格
- 函数名和方法名尽量使用动词开头，全部小写加下划线分割，或小驼峰规则
- 函数尽量不超过 100 行，类尽量不超过 1000 行，太多后进行逻辑提取
- Model 里不要使用 SQL 拼接，防止 SQL 注入
- Controller里每个参数都需要进行空验证，类型验证，长度验证
- Controller里所有数据库操作前必须验证权限
- Controller 里复杂逻辑封装到 Model 里
- View 里所有  <?= 和 echo 要加 html 编码，防止 XSS 注入

---
# 代码检查规范

- 个人提交代码前要进行代码自查
	- 测试代码，临时代码不能提交
	- 不符合代码编写规范的代码不能提交
	- 有语法错误，没编译通过的代码不能提交
	- 没经过测试的代码不能提交
- 代码提交后进行交叉代码检查
	- 防止自查遗漏
	- 重点是代码风格和安全问题
- 代码合并到 master 需要在工蜂提交 merge request
	- 专人进行检查，确认更新文件列表及变动详情

---
# 数据库规范

- 统一实体命名单词
- 数据表名以模块名开头
- 数据表使用 innodb 引擎，utf8mb4 编码，utf8mb4_general_ci 排序规则
- 建表 sql 考虑创建合适的索引以提高性能
- 建表 sql 的表和列要加注释
- 数据库初始化脚本和增量脚本分开维护

---
# 数据接口规范

- 请求使用 form-data 格式
- 应答 json 结构统一，包含错误码和错误描述
	- ｛code: 0, message: 'ok', data: [1, 2, 3]｝
- 公共错误码
	- 正常： 0
	- 客户端错误：4xx
	- 服务端错误：5xx
	- 需要登录：401

---
# 上线规范

- 发送上线邮件通知
	- 包含：上线功能列表，上线时间，上线文件列表，上线步骤，用户影响评估
- 待上线功能必须在 testing 分支进行测试
- 明确上线文件列表，防止夹带功能
- 使用 git pull 进行代码更新
- 如果更新后出问题，要有回退方案
- 如果上线需要改表，加表等，需要在更新点前手工执行

